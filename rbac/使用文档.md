# RBAC组件的使用文档

## 使用说明

### 一、将rbac组件拷贝到项目中。

### 二、将rbac/migrations目录中的数据库迁移记录删除（__init__.py不能删除）

### 三、进行业务开发
##### 1..对于用户表使用one2one将用户表拆分到两种表中，如：
* rbac/models.py
```
class UserInfo(models.Model):
    """
    用户表
    """
    name = models.CharField(verbose_name='用户名', max_length=32)
    password = models.CharField(verbose_name='密码', max_length=64)
    email = models.CharField(verbose_name='邮箱', max_length=32)
    roles = models.ManyToManyField(verbose_name='拥有的所有角色', to='Role', blank=True)

    def __str__(self):
        return self.name
```
* 业务/models.py
```
class Host(models.Model):
    """主机表"""
    hostname = models.CharField(verbose_name='主机名', max_length=32)
    ip = models.GenericIPAddressField(verbose_name='IP', protocol='both')
    department = models.ForeignKey(verbose_name='归属部门', to='Department', on_delete=models.CASCADE)

    def __str__(self):
        return self.hostname
```
* 缺点：用户表分散在两个表中
* 优点：利用上rbac中的用户管理的功能

##### 2. 用户表整合在一张表中（推荐使用）
* rbac/models.py
```
class UserInfo(models.Model):
    """
    用户表
    """
    name = models.CharField(verbose_name='用户名', max_length=32)
    password = models.CharField(verbose_name='密码', max_length=64)
    email = models.CharField(verbose_name='邮箱', max_length=32)
    roles = models.ManyToManyField(verbose_name='拥有的所有角色', to='Role', blank=True)

    def __str__(self):
        return self.name

    class Meta:
        # django以后再做数据库迁移时，不再为UserInfo类创建相关的表以及表结构了
        # 此类可以当做"父类"，被其他Model类继承。里面的字段就自动过度给继承它的类了
        abstract = True

```
* 优点：将所有的用户信息放入到一张表中（业务的用户表中）
* 缺点：所有关于用户表的操作，不能使用了。

**注意：rbac中两处使用了用户表**
1. 用户管理。【删除】
2. 权限分配时的用户列表。【不要读取rbac的用户表了，读取业务中的用户表】

***严重提醒：***
* 在rbac的admin中删除注册表，Userinfo已经是抽象的了，无法注册admin
* rbac中的Role不要加引号

**对于rbac中的代码的修改**
1. 在URL中将用户表的增删改查和修改密码的功能删除。
2. 在权限分配时，读取用户表变成通过配置文件来进行指定并导入。

##### 3.正式进入业务开发
1. 用户表的增删改查
2. 主机表的增删改查
3. 如果要使用rbac中的模板，则需要将模板中的导航条和菜单先去掉，当业务开发完成之后，上线之前再把它们拿回来。
```
...
<div class="pg-body">
    <div class="left-menu">
        <div class="menu-body">
        </div>
    </div>
    <div class="right-body">
        {% block content %} {% endblock %}
    </div>
</div>
...
```
* 感受：编写业务功能时，出现了大量的拷贝。(用stark组件）

##### 4.权限的应用
1. 将菜单和导航条，添加到layout.html中
```
...
<div class="pg-body">
    <div class="left-menu">
        <div class="menu-body">
                        {% multi_menu request %}
        </div>
    </div>
    <div class="right-body">
                {% breadcrumb request %}
        {% block content %} {% endblock %}
    </div>
</div>
...
```
2. 应用中间件 ，在settings.py中加入
```
 'rbac.middlewares.rbac.RbacMiddle',
```
3. 白名单处理，在settings.py中添加以下配置（根据需求，自行添加）
```
  AUTO_DISCOVER_EXCLUDE = [
    '/admin.*',
    '/login/',
]
```
4. 在settings.py中添加以下配置
```
PERMISSION_SESSION_KEY = 'permission_url_list_key'
MENU_SESSION_KEY = 'permission_menu_key'
```

5. 批量操作权限时，自动发现路由中所有的URL时，应该排除的URL
```
AUTO_DISCOVER_EXCLUDE = [
    '/admin.*',
    '/login/',
]
```

6. 用户登录的逻辑
写完用户登录逻辑，对于/index/,/login/,/logout/的权限，是否用分配？
 


## 注意事项

**rbac中用户管理的逻辑部分只写了基本的功能，如果不能满足需求，需要在业务的逻辑部分中自己写。**
